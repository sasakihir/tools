# 概要

Windowsで、実行中のすべてのJavaのスレッドダンプを取得する

# フォルダ構成

```
threaddump_alljvm 
|   README.md  
|   threaddump_alljvm.bat  
|  
\---log  
        yyyymmddhhmmss.tasklist.log  
        yyyymmddhhmmss.jps.log  
        yyyymmddhhmmss.threaddump.pid-xxxxx.log  
        yyyymmddhhmmss.threaddump.pid-xxxxx.err.log
```

logフォルダ以下は、バッチ実行時に生成される

# 仕様

- 指定した間隔で、指定回数スレッドダンプを取得する。
- スレッドダンプの取得にはJDKに含まれるjstack.exeを利用する。

# 前提

- JDKをインストール済み

# 準備

- threaddump_alljvm.batを適当なフォルダに配置する
- threaddump_alljvm.batをエディタで開き、以下をセットする

```
set jdk_home=<JDKのインストールディレクトリ> ex. C:\Program Files\Java\jdk1.8.0_222  
set waits=<スレッドダンプの取得間隔(秒)>  
set times=<スレッドダンプの取得回数>  
```

# 実行の仕方-1. 手動実行

- スケジュール実行する場合でも、最初に手動実行でテストすることを推奨する
- threaddump_alljvm.batを管理者実行する
- log配下にスレッドダンプが出力されたことを確認する

# 実行の仕方-2. スケジュール実行
## 準備

- 以下手順でタスクスケジューラ登録をする

- タスクスケジューラ起動 (コントロールパネル > コンピュータの管理などから)
- タスクを作成するフォルダを開く (タスクスケジューラライブラリなど)
- 右ペインからタスクの作成をクリック

```
[全般タブ]  
・名前: 任意 (ex. threaddump_alljvm)  
  
セキュリティオプション  
・タスクの実行時に使うユーザーアカウント: 作業用ユーザが指定されてるか確認  
・ユーザーがログオンしているかどうかにかかわらず実行する、にチェック  
・最上位の特権で実行する、にチェック  
他はデフォルトのままでOK  
  
[トリガー]タブ  
・タスクの開始: スケジュールに従う  
  
設定  
・取得要件に応じて、1回または毎日などを選択  
・開始: スレッドダンプ取得開始日時を指定  
タイムゾーンにまたがって同期、はチェックしなくて大丈夫  
他はデフォルトのままでOK  
  
[操作]タブ  
threaddump_alljvm.batを指定  
  
(登録完了)  
OKをクリックして、タスク実行用に指定したユーザのパスワードを入力して閉じる  
```

- タスクを手動実行する
- スレッドダンプが出力されたことを確認する

## スケジュール実行動作確認

- タスクスケジューラで指定した日時を過ぎたあと、スレッドダンプが正常に出力されたことを確認する

# 動作確認済み環境
- Windows 10

# トラブルシューティング

- スレッドダンプが出力されない
  - jstack.exeを実行できていない状態なので、以下を確認
  - jdkのパス
  - %jdk_home%\bin配下にjstack.exeはあるか
- スレッドダンプが0バイト
  - yyyymmddhhmmss.threaddump.pid-xxxxx.err.logの内容を確認する
  - 対象のJavaプロセスにアタッチする権限がないことがほとんど
  - 対象のJavaプロセスの実行アカウントと同じOSアカウントでログインする
  - 管理者権限で実行する
